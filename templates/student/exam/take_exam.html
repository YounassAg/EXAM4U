{% extends 'base.html' %}
{% load static %}

{% block title %}{{ exam.title }} - Exam4U{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/eclipse.min.css" rel="stylesheet">
<style>
    .CodeMirror {
        height: 200px;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 14px;
    }
    
    .dark .CodeMirror {
        border-color: #4b5563;
    }
    
    .CodeMirror-focused {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-gray-50 dark:bg-gray-900">
    {% include 'components/student_sidebar.html' %}
    
    <div class="flex-1 p-4 md:p-8">
        <!-- Main Content -->
        <div class="space-y-6 md:space-y-8">
            <!-- Title Section -->
            <div class="relative overflow-hidden bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 hover:shadow-xl hover:border-blue-500 dark:hover:border-blue-500 transition-all duration-300">
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 bg-gradient-to-br from-blue-500/20 to-purple-500/20 dark:from-blue-400/10 dark:to-purple-400/10 rounded-full blur-3xl animate-pulse"></div>
                <div class="absolute bottom-0 left-0 -mb-4 -ml-4 w-32 h-32 bg-gradient-to-tr from-purple-500/20 to-pink-500/20 dark:from-purple-400/10 dark:to-pink-400/10 rounded-full blur-3xl animate-pulse delay-1000"></div>
                <div class="relative z-10 p-6 md:p-8">
                    <div class="flex flex-col space-y-4">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-400 dark:to-purple-400 bg-clip-text text-transparent">{{ exam.title }}</h1>
                            <div class="flex items-center space-x-6 flex-wrap gap-4">
                                <div class="flex items-center space-x-2">
                                    <div class="p-2 rounded-lg bg-gradient-to-br from-blue-500/10 to-purple-500/10 dark:from-blue-400/5 dark:to-purple-400/5">
                                        {% include 'components/icons.html' with icon="clock" class="w-5 h-5 text-blue-600 dark:text-blue-400" %}
                                    </div>
                                    <span id="timer" class="font-mono text-lg font-medium text-blue-600 dark:text-blue-400"></span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="p-2 rounded-lg bg-gradient-to-br from-blue-500/10 to-purple-500/10 dark:from-blue-400/5 dark:to-purple-400/5">
                                        {% include 'components/icons.html' with icon="refresh" class="w-5 h-5 text-blue-600 dark:text-blue-400" %}
                                    </div>
                                    <span class="text-gray-600 dark:text-gray-400">Tentative: {{ attempt_number }}/{{ exam.max_attempts }}</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400">{{ exam.description }}</p>
                    </div>
                </div>
            </div>

            <!-- Questions Form -->
            <form id="examForm" method="post" class="space-y-6 md:space-y-8">
                {% csrf_token %}
                {% for question in questions %}
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 space-y-4">
                        <!-- Question Header -->
                        <div class="flex items-center space-x-3">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Question {{ forloop.counter }}</h3>
                            <span class="text-sm text-gray-600 dark:text-gray-400">({{ question.points }} points)</span>
                        </div>

                        <!-- Question Text -->
                        <div class="text-gray-700 dark:text-gray-300">{{ question.wording }}</div>
                    
                        <!-- Choices or Answer Field -->
                        <div class="space-y-3 mt-4">
                            {% if question.question_type == 'MCQ' %}
                                {% for choice in question.mcqchoice_set.all %}
                                    {% if question.allow_multiple_answers %}
                                        <label class="flex items-start p-4 rounded-lg bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-600">
                                            <div class="flex items-center h-5">
                                                <input type="checkbox" 
                                                       name="question_{{ question.id }}" 
                                                       value="{{ choice.id }}"
                                                       class="w-4 h-4 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
                                            </div>
                                            <div class="ml-3 flex-1 min-w-0">
                                                <span class="text-gray-900 dark:text-white">{{ choice.choice_label }}</span>
                                            </div>
                                        </label>
                                    {% else %}
                                        <label class="flex items-start p-4 rounded-lg bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-600">
                                            <div class="flex items-center h-5">
                                                <input type="radio" 
                                                       name="question_{{ question.id }}" 
                                                       value="{{ choice.id }}"
                                                       class="w-4 h-4 text-blue-600 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
                                                       required>
                                            </div>
                                            <div class="ml-3 flex-1 min-w-0">
                                                <span class="text-gray-900 dark:text-white">{{ choice.choice_label }}</span>
                                            </div>
                                        </label>
                                    {% endif %}
                                {% endfor %}
                            {% elif question.question_type == 'short_answer' %}
                                <div>
                                    <input type="text" 
                                           name="question_{{ question.id }}" 
                                           class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           required>
                                </div>
                            {% elif question.question_type == 'open' %}
                                <div class="code-question-wrapper space-y-2">
                                    <!-- Language selector -->
                                    <select class="language-selector w-full sm:w-auto rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-2">
                                        <option value="python">Python</option>
                                        <option value="javascript">JavaScript</option>
                                        <option value="php">PHP</option>
                                        <option value="sql">MySQL/SQL</option>
                                    </select>
                                    
                                    <!-- Code editor -->
                                    <textarea name="question_{{ question.id }}" class="code-editor" required></textarea>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button type="button" 
                            onclick="history.back()" 
                            class="w-full sm:w-auto group inline-flex items-center justify-center px-6 py-3 text-gray-600 dark:text-gray-400 hover:text-white dark:hover:text-white bg-transparent hover:bg-gradient-to-r hover:from-gray-600 hover:to-gray-700 dark:hover:from-gray-500 dark:hover:to-gray-600 rounded-lg transition-all duration-300 hover:shadow-[0_0_15px_rgba(75,85,99,0.25)] hover:-translate-y-0.5">
                        <span class="mr-2">{% include 'components/icons.html' with icon="arrow-left" class="w-5 h-5" %}</span>
                        Retour
                    </button>
                    <button type="button"
                            onclick="confirmSubmit()"
                            class="w-full sm:w-auto group inline-flex items-center justify-center px-6 py-3 text-white bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-500 dark:to-purple-500 hover:from-blue-700 hover:to-purple-700 dark:hover:from-blue-600 dark:hover:to-purple-600 rounded-lg transition-all duration-300 hover:shadow-[0_0_15px_rgba(59,130,246,0.5)] hover:-translate-y-0.5">
                        <span class="mr-2">{% include 'components/icons.html' with icon="check" class="w-5 h-5" %}</span>
                        Soumettre
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/php/php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Store editor instances
    const editors = new Map();
    
    // Language mode mapping with proper configurations
    const languageModes = {
        'python': {
            name: 'python',
            version: 3
        },
        'javascript': {
            name: 'javascript'
        },
        'php': {
            name: 'php',
            startOpen: true
        },
        'sql': {
            name: 'text/x-mysql'
        }
    };
    
    // Initialize editors
    document.querySelectorAll('.code-question-wrapper').forEach(wrapper => {
        const textarea = wrapper.querySelector('.code-editor');
        const languageSelect = wrapper.querySelector('.language-selector');
        
        // Create editor with proper mode configuration
        const editor = CodeMirror.fromTextArea(textarea, {
            lineNumbers: true,
            mode: languageModes[languageSelect.value],
            theme: document.documentElement.classList.contains('dark') ? 'monokai' : 'eclipse',
            indentUnit: 4,
            smartIndent: true,
            lineWrapping: true,
            matchBrackets: true,
            autoCloseBrackets: true,
            extraKeys: {
                'Tab': function(cm) {
                    cm.replaceSelection('    ');
                }
            }
        });
        
        // Store editor instance
        editors.set(textarea.name, editor);
        
        // Handle language changes
        languageSelect.addEventListener('change', function() {
            editor.setOption('mode', languageModes[this.value]);
        });
        
        // Sync editor content with textarea
        editor.on('change', function() {
            editor.save();
        });
        
        // Add PHP opening tag if PHP is selected
        if (languageSelect.value === 'php') {
            editor.setValue('<?php\n\n');
            editor.setCursor(2, 0);
        }
        
        // Handle language change and auto-insert tags
        languageSelect.addEventListener('change', function() {
            const newValue = this.value;
            let currentCode = editor.getValue().trim();
            
            // Remove old PHP tags if they exist
            if (currentCode.startsWith('<?php')) {
                currentCode = currentCode.replace('<?php', '').trim();
            }
            
            // Add appropriate tags for the new language
            if (newValue === 'php' && !currentCode.startsWith('<?php')) {
                editor.setValue('<?php\n\n' + currentCode);
                editor.setCursor(editor.lineCount(), 0);
            } else {
                editor.setValue(currentCode);
            }
            
            editor.setOption('mode', languageModes[newValue]);
        });
    });
    
    // Handle theme changes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'class') {
                const isDark = document.documentElement.classList.contains('dark');
                editors.forEach(editor => {
                    editor.setOption('theme', isDark ? 'monokai' : 'eclipse');
                });
            }
        });
    });
    
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
    });
    
    // Timer functionality
    const timerElement = document.getElementById('timer');
    const endTime = new Date('{{ exam.end_date|date:"c" }}').getTime();
    
    function updateTimer() {
        const now = new Date().getTime();
        const timeLeft = endTime - now;
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            autoSubmitExam();
            return;
        }
        
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
    
    // Form submission handling
    window.confirmSubmit = function() {
        if (confirm('Êtes-vous sûr de vouloir soumettre votre examen ? Cette action est irréversible.')) {
            // Save all editors before submitting
            editors.forEach(editor => editor.save());
            document.getElementById('examForm').submit();
        }
    };
    
    // Auto-submit when time is up
    window.autoSubmitExam = function() {
        alert('Le temps est écoulé ! Votre examen va être soumis automatiquement.');
        // Save all editors before submitting
        editors.forEach(editor => editor.save());
        document.getElementById('examForm').submit();
    };
    
    // Prevent accidental navigation
    window.addEventListener('beforeunload', function(e) {
        const confirmationMessage = 'Êtes-vous sûr de vouloir quitter la page ? Toutes les réponses non soumises seront perdues.';
        e.returnValue = confirmationMessage;
        return confirmationMessage;
    });
});
</script>
{% endblock %}
